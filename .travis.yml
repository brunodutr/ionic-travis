dist: trusty

env:
  global:
    - JAVA_HOME=/usr/lib/jvm/java-8-oracle
    - LANG=pt_BR.UTF-8
    - CHROME_BIN=google-chrome
    - VERSION-BUILD-TOOLS=28.0.3
    - VERSION-ANDROID=28

branches:
  only:
    - master
    - prod

language: node_js
node_js: '9'

notifications:
  email:
    recipients:
      - brunodutrafranco@id.uff.br

matrix:
  include:
    - os: linux
      sudo: false
      language: android
      android:
        components:
          - build-tools-${VERSION-BUILD-TOOLS}
          - android-${VERSION-ANDROID}
      addons:
        apt:
          sources:
            - sourceline: deb https://dl.yarnpkg.com/debian/ stable main
              key_url: https://dl.yarnpkg.com/debian/pubkey.gpg
            - sourceline: deb http://dl.google.com/linux/chrome/deb/ stable main
              key_url: https://dl-ssl.google.com/linux/linux_signing_key.pub
          packages:
            - google-chrome-stable
            - gradle
            - jq
            - oracle-java8-installer
            - oracle-java8-set-default
before_install:
  - export VERSION=$(node -p -e "require('./package.json').version")

  - git config --local user.name $GITHUB_USERNAME
  - git config --local user.email $GITHUB_EMAIL

  - nvm install node

  - npm install -g ionic cordova

install:
  - npm install

script:
  - './travis/build.sh'

  - './travis/sign.sh'

  - if [[ "$TRAVIS_BRANCH" == "prod" ]]; then
    export SNAPSHOT=false;
    fi

  - if [[ "$TRAVIS_BRANCH" != "prod" ]]; then
    export VERSION=${VERSION}-SNAPSHOT &&
    export SNAPSHOT=true ;
    fi

before_cache:
  - rm -f  $HOME/.gradle/caches/modules-2/modules-2.lock
  - rm -f  $HOME/.gradle/caches/transforms-1/transforms-1.lock
  - rm -rf $HOME/.gradle/caches/3.5/fileHashes/
  - rm -rf $HOME/.gradle/caches/*/plugin-resolution/

cache:
  directories:
    - '$HOME/.gradle/caches/'
    - '$HOME/.gradle/wrapper/'
    - './node_modules'

before_deploy:
  - ./travis/before_deploy.sh

deploy:
  provider: releases
  api_key:
    secure: '$GITHUB_TOKEN'
  file_glob: true
  file: ionictravis-${VERSION}.apk
  prerelease: '$SNAPSHOT'
  overwrite: '$SNAPSHOT'
  skip_cleanup: true
  target_commitish: '$TRAVIS_COMMIT'
  on:
    repo: '$TRAVIS_REPO_SLUG'
    all_branches: true
    tags: false

after_deploy:
  - ./travis/release.sh
