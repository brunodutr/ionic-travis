dist: trusty

sudo: false
language: android

env:
  global:
    - JAVA_HOME=/usr/lib/jvm/java-8-oracle
    - LANG=pt_BR.UTF-8
    - CHROME_BIN=google-chrome
    - VERSION-BUILD-TOOLS=27.0.3
    - VERSION-ANDROID=27

branches:
  only:
    - master
    - prod

notifications:
  email:
    on_success: never
    on_failure: change

stages:
  - Prepare Cache
  - Tests
  - Build
  - Deploy
  - Package
  - Release
  - Code Analisys

fast_finish: true

install:
  - nvm install 11
  - npm install

  - export VERSION=$(node -p -e "require('./package.json').version")

  - if [[ "$TRAVIS_BRANCH" == "prod" ]]; then
    export SNAPSHOT=false;
    fi

  - if [[ "$TRAVIS_BRANCH" != "prod" ]]; then
    export VERSION=${VERSION}-SNAPSHOT &&
    export SNAPSHOT=true ;
    fi

before_cache:
  - rm -f  $HOME/.gradle/caches/modules-2/modules-2.lock
  - rm -f  $HOME/.gradle/caches/transforms-1/transforms-1.lock
  - rm -rf $HOME/.gradle/caches/3.5/fileHashes/
  - rm -rf $HOME/.gradle/caches/*/plugin-resolution/

cache:
  directories:
    - '$HOME/.gradle/caches/'
    - '$HOME/.gradle/wrapper/'
    - './node_modules'
    - '$HOME/.cache/pip'
    - '$HOME/.npm'
    - '$HOME/.sonar/cache'

jobs:
  include:
    - stage: 'Prepare cache'
      script: true

    - name: 'Lint'
      install:
        - nvm install 11
      stage: 'Tests'
      script:
        - npm run lint

    - name: 'Unit Tests'
      stage: 'Tests'
      addons:
        apt:
          sources:
            - deadsnakes
            - sourceline: deb http://dl.google.com/linux/chrome/deb/ stable main
              key_url: https://dl-ssl.google.com/linux/linux_signing_key.pub
          packages:
            - google-chrome-stable
            - python3.6
          update: true
      before_install:
        - pip install --user awscli
        - mkdir -p ~/shared
        - aws s3 sync s3://ionic-travis/$TRAVIS_BUILD_NUMBER ~/shared
      after_success:
        - aws s3 sync ~/shared s3://ionic-travis/$TRAVIS_BUILD_NUMBER
      script:
        - npm run unit-ci
        - cp coverage/lcov.info ~/shared/lcov.info

    - name: 'e2e Tests'
      stage: 'Tests'
      addons:
        apt:
          sources:
            - sourceline: deb http://dl.google.com/linux/chrome/deb/ stable main
              key_url: https://dl-ssl.google.com/linux/linux_signing_key.pub
          packages:
            - google-chrome-stable
          update: true
      script:
        - npm run e2e-ci

    - name: 'Build Android'
      stage: 'Build'
      before_install:
        - pip install --user awscli
        - mkdir -p ~/shared
        - aws s3 sync s3://ionic-travis/$TRAVIS_BUILD_NUMBER ~/shared
      after_success:
        - aws s3 sync ~/shared s3://ionic-travis/$TRAVIS_BUILD_NUMBER
      android:
        components:
          - build-tools-28.0.3
          - android-28
        licenses:
          - android-sdk-preview-.+
          - android-sdk-license-.+
          - google-gdk-license-.+
      addons:
        apt:
          sources:
            - deadsnakes
            - sourceline: deb https://dl.yarnpkg.com/debian/ stable main
              key_url: https://dl.yarnpkg.com/debian/pubkey.gpg
          packages:
            - gradle
            - jq
            - oracle-java8-installer
            - oracle-java8-set-default
            - python3.6
          update: true
      script:
        - npm install -g ionic cordova
        - ionic cordova build android --prod --release
        - cp platforms/android/app/build/outputs/apk/release/app-release-unsigned.apk ~/shared/app-release-unsigned.apk

    - name: 'Build IOS'
      stage: 'Build'
      os: osx
      language: objective-c
      osx_image: xcode10
      install:
        - brew update
        - brew install yarn ios-sim jq ios-deploy cocoapods
        - brew link --overwrite cocoapods
        - rvm use system
        - pod setup
      script:
        - nvm install 11
        - yarn install
        - yarn global add ionic cordova
        - ionic cordova build ios
      allow_failures:
        os: osx
        language: objective-c
        osx_image: xcode10

    - name: 'Package Android'
      stage: 'Package'
      android:
        components:
          - build-tools-28.0.3
          - android-28
        licenses:
          - android-sdk-preview-.+
          - android-sdk-license-.+
          - google-gdk-license-.+
      addons:
        apt:
          sources:
            - deadsnakes
          packages:
            - python3.6
          update: true
      before_install:
        - pip install --user awscli
        - mkdir -p ~/shared
        - aws s3 sync s3://ionic-travis/$TRAVIS_BUILD_NUMBER ~/shared
      after_success:
        - aws s3 sync ~/shared s3://ionic-travis/$TRAVIS_BUILD_NUMBER
      script:
        - ./travis/sign.sh

    - name: 'Package IOS'
      stage: 'Package'
      os: osx
      language: objective-c
      install: true
      script:
        - echo "Package IOS"

    - stage: 'Deploy'
      install: skip
      if: type != pull_request
      script:
        - ./travis/before_deploy.sh
      deploy:
        provider: releases
        api_key:
          secure: '$GITHUB_TOKEN'
        file_glob: true
        file: ionictravis-${VERSION}.apk
        prerelease: '$SNAPSHOT'
        overwrite: '$SNAPSHOT'
        name: 'v${VERSION}'
        skip_cleanup: true
        on:
          repo: '$TRAVIS_REPO_SLUG'
          all_branches: true
          tags: false

    - stage: 'Release'
      install: skip
      script:
        - ./travis/release.sh
      if: branch = prod

    - name: 'Sonar'
      stage: 'Code Analisys'
      install:
        - nvm install 11
      addons:
        sonarcloud:
          organization: 'brunodutr-github'
          token:
            secure: $SONAR_TOKEN
        apt:
          sources:
            - deadsnakes
          packages:
            - python3.6
          update: true
      before_install:
        - pip install --user awscli
        - mkdir -p ~/shared
        - aws s3 sync s3://ionic-travis/$TRAVIS_BUILD_NUMBER ~/shared
      after_success:
        - aws s3 rm --recursive s3://ionic-travis
      script:
        - mkdir -p coverage

        - mv ~/shared/lcov.info coverage/lcov.info

        - sonar-scanner -Dsonar.projectVersion=${VERSION}
          -Dsonar.links.homepage=https://github.com/${TRAVIS_REPO_SLUG}
          -Dsonar.links.ci=https://travis-ci.com/${TRAVIS_REPO_SLUG}
          -Dsonar.links.scm=https://github.com/${TRAVIS_REPO_SLUG}
          -Dsonar.links.issue=https://github.com/${TRAVIS_REPO_SLUG}/issues
