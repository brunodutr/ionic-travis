dist: trusty

env:
  global:
    - JAVA_HOME=/usr/lib/jvm/java-8-oracle
    - PATH=$HOME/.local/bin:$PATH
    - LANG=pt_BR.UTF-8
    - CHROME_BIN=google-chrome
    - VERSION-BUILD-TOOLS=27.0.3
    - VERSION-ANDROID=27

branches:
  only:
    - master
    - prod

notifications:
  email:
    recipients:
      - brunodutrafranco@id.uff.br

matrix:
  include:
    - os: linux
      sudo: false
      language: android
      fast_finish: true
      android:
        components:
          - build-tools-28.0.3
          - android-28
        licenses:
          - android-sdk-preview-.+
          - android-sdk-license-.+
          - google-gdk-license-.+
      addons:
        apt:
          sources:
            - sourceline: deb https://dl.yarnpkg.com/debian/ stable main
              key_url: https://dl.yarnpkg.com/debian/pubkey.gpg
            - sourceline: deb http://dl.google.com/linux/chrome/deb/ stable main
              key_url: https://dl-ssl.google.com/linux/linux_signing_key.pub
          packages:
            - google-chrome-stable
            - gradle
            - jq
            - oracle-java8-installer
            - oracle-java8-set-default
            - python-pip
          update: true
        sonarcloud:
          organization: 'brunodutr-github'
          token:
            secure: $SONAR_TOKEN

before_install:
  - git config --local user.name $GITHUB_USERNAME
  - git config --local user.email $GITHUB_EMAIL
  - google-chrome-stable --version

install:
  - nvm install 11
  - npm install -g ionic cordova  
  - npm install
  - pip install --user awscli
  - mkdir -p ~/$TRAVIS_REPO_SLUG/$TRAVIS_BUILD_NUMBER
  - aws s3 sync s3://ionic-travis/$TRAVIS_BUILD_NUMBER ~/$TRAVIS_REPO_SLUG/$TRAVIS_BUILD_NUMBER
  
script:

  - export VERSION=$(node -p -e "require('./package.json').version")

  - if [[ "$TRAVIS_BRANCH" == "prod" ]]; then
      export SNAPSHOT=false;
    fi

  - if [[ "$TRAVIS_BRANCH" != "prod" ]]; then
      export VERSION=${VERSION}-SNAPSHOT &&
      export SNAPSHOT=true ;
    fi

  - ./travis/tests.sh

  - ./travis/build.sh
  
  - ./travis/sign.sh
  
before_cache:
  - rm -f  $HOME/.gradle/caches/modules-2/modules-2.lock
  - rm -f  $HOME/.gradle/caches/transforms-1/transforms-1.lock
  - rm -rf $HOME/.gradle/caches/3.5/fileHashes/
  - rm -rf $HOME/.gradle/caches/*/plugin-resolution/

cache:
  directories:
    - '$HOME/.gradle/caches/'
    - '$HOME/.gradle/wrapper/'
    - '$HOME/.sonar/cache'
    - './node_modules'

before_deploy:
  - ./travis/before_deploy.sh

deploy:
  provider: releases
  api_key:
    secure: '$GITHUB_TOKEN'
  file_glob: true
  file: ionictravis-${VERSION}.apk
  prerelease: '$SNAPSHOT'
  overwrite: '$SNAPSHOT'
  name: 'v${VERSION}'
  skip_cleanup: true
  on:
    repo: '$TRAVIS_REPO_SLUG'
    all_branches: true
    tags: false

after_deploy:
  - ./travis/release.sh
